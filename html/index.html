<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>phys</title>
	</head>

	<body>
		<div id="container"></div>

		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script src="http://jquery-json.googlecode.com/files/jquery.json-2.4.min.js"></script>
		<script src="http://jquery-websocket.googlecode.com/files/jquery.websocket-0.0.1.js"></script>
		<script src="http://www.html5canvastutorials.com/libraries/kinetic-v4.3.0-beta2.js"></script>
		<script src="raf.js"></script>

		<script>
			var stage = new Kinetic.Stage({
				container: 'container',
				width: 500,
				height: 500
			});
			var layer = new Kinetic.Layer();
			var box = new Kinetic.Rect({
				x: 0,
				y: 0,
				width: 500,
				height: 500,
				stroke: 'black',
				strokeWidth: 2
			});
			layer.add(box);
			var circles = [];
			var touch = -1;
			var userPos = {x: 0, y: 0};
			for (var i = 0; i < 50; i++) {
				var c = new Kinetic.Circle({
					x: 250,
					y: 250,
					radius: 10,
					fill: 'red',
					stroke: 'black',
					strokeWidth: 2
				});
				(function(id) {
					c.on('mouseenter tap', function(e) {
						touch = id;
					});
				})(i + 1);
				circles.push(c);
				layer.add(c);
			}
			stage.add(layer);
			var ws = $.websocket("ws://bitgnome.net:3000/phys/", {
				open: function() { alert("open!"); },
				events: {
					message: function(e) {
						for (var i = 0; i < e.data.length; i++) {
							circles[e.data[i].Id - 1].setPosition(e.data[i].X, 500 - e.data[i].Y);
						}
					}
				}
			});
			function anim() {
				requestAnimationFrame(anim);
				stage.draw();
				var pos = stage.getUserPosition();
				if (pos) {
					userPos = pos;
				}
				ws.send('message', [touch, userPos]);
				touch = -1
			}
			anim();
		</script>
	</body>
</html>
