<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>phys</title>
	</head>

	<body>
		<div id="container"></div>

		<script src="jquery.min.js"></script>
		<script src="jquery.json-2.4.min.js"></script>
		<script src="jquery.websocket-0.0.1.js"></script>
		<script src="kinetic-v4.3.1.min.js"></script>
		<script src="raf.js"></script>

		<script>
			var stage = new Kinetic.Stage({
				container: 'container',
				width: 500,
				height: 500
			});

			var layer = new Kinetic.Layer();

			var box = new Kinetic.Rect({
				x: 0,
				y: 0,
				width: 500,
				height: 500,
				stroke: 'black',
				strokeWidth: 2
			});
			layer.add(box);

			var balls = [];
			var touch = -1;
			var userPos = {x: 0, y: 0};
			var cursors = [];

			function newBall() {
				var b = new Kinetic.Group();
				var circle = new Kinetic.Circle({
					radius: 10,
					fill: 'red',
					stroke: 'black',
					strokeWidth: 2
				});
				var line = new Kinetic.Line({
					points: [0, 0, 0, 10],
					stroke: 'black',
					strokeWidth: 2
				});
				b.add(circle);
				b.add(line);
				(function(id) {
					b.on('mouseenter tap', function(e) {
						touch = id;
					});
				})(balls.length + 1);
				balls.push(b);
				layer.add(b);
			}

			var cursorShape = new Kinetic.Shape({
				drawFunc: function(canvas) {
					if (!cursors.length) {
						return;
					}
					var context = canvas.getContext();
					for (var i = 0; i < cursors.length; i++) {
						context.beginPath();
						context.arc(cursors[i].X, cursors[i].Y, 5, 0, 2 * Math.PI, true);
						context.closePath();
						canvas.fillStroke(this);
					}
				},
				fill: 'black',
				stroke: 'black',
				strokeWidth: 2
			});
			layer.add(cursorShape);
			stage.add(layer);
 			var ws = $.websocket("ws://" + window.location.host + "/phys/", {
				events: {
					message: function(e) {
						for (var i = 0; i < e.data.balls.length; i++) {
							if (i >= balls.length) {
								newBall();
							}
							balls[i].setPosition(e.data.balls[i].Pos.X, 500 - e.data.balls[i].Pos.Y);
							balls[i].setRotation(-e.data.balls[i].Angle);
						}
						cursors = e.data.cursors;
					}
				}
			});
			function anim() {
				requestAnimationFrame(anim);
				stage.draw();
				var pos = stage.getUserPosition();
				if (pos) {
					userPos = pos;
				}
				ws.send('message', [touch, userPos]);
				touch = -1
			}
			anim();
		</script>
	</body>
</html>
